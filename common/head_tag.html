<script type="text/discourse-plugin" version="0.2">
  api.onPageChange((url, title) => {
    window._paq = window._paq || [];
    window._paq_loaded = window._paq_loaded || false;

    if (!_paq_loaded) {
      var u = `//${settings.host_url}/`;
      _paq.push(['setTrackerUrl', u+'piwik.php']);
      _paq.push(['setSiteId', settings.website_id]);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      _paq_loaded = true;
    }

    const currentUser = api._currentUser;
    _paq.push(['setCustomVariable', 1, 'Anonymous', !currentUser, 'visit']);
    _paq.push(["setCustomUrl", url]);
    _paq.push(["setDocumentTitle", title]);
    _paq.push(["trackPageView"]);
    _paq.push(['enableLinkTracking']);

    if (settings.crossdomain_tracking) {
      var slashPos = settings.host_url.indexOf('/');
      var siteDomain = slashPos == -1 ? settings.host_url : settings.host_url.substr(0, slashPos);
      _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
      _paq.push(["setCookieDomain", "*." + siteDomain]);
      _paq.push(["setDomains", "*." + siteDomain]);
      _paq.push(["enableCrossDomainLinking"]);
    }
  });
</script>
